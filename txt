#!/bin/bash
#
#  Shef OS Install v.3.3
#────────────────────────────────────────────────────────|
#           .
# Author    . LinuxShef
#           .
# Project   .
#           .
# License   . LGPL-3.0 (http://opensource.org/licenses/lgpl-3.0.html)
#           .
#──────────────────────────────────────────────────────────────────────|
clear
echo '









                                                                ShefOS Install v.3.3

                                      ─────────────────────────────────────────────────────────────────────────



                                            ██╗      ██████╗  █████╗ ██████╗ ██╗███╗   ██╗ ██████╗
                                            ██║     ██╔═══██╗██╔══██╗██╔══██╗██║████╗  ██║██╔════╝
                                            ██║     ██║   ██║███████║██║  ██║██║██╔██╗ ██║██║  ███╗
                                            ██║     ██║   ██║██╔══██║██║  ██║██║██║╚██╗██║██║   ██║
                                            ███████╗╚██████╔╝██║  ██║██████╔╝██║██║ ╚████║╚██████╔╝██╗██╗██╗
                                            ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ ╚═╝╚═╝  ╚═══╝ ╚═════╝ ╚═╝╚═╝╚═╝



                                       ─────────────────────────────────────────────────────────────────────────
'
sed -i s/'#en_US.UTF-8'/'en_US.UTF-8'/g /etc/locale.gen
sed -i s/'#ru_RU.UTF-8'/'ru_RU.UTF-8'/g /etc/locale.gen
chmod 777 /etc/locale.conf
chmod 777 /etc/vconsole.conf
echo 'LANG=ru_RU.UTF-8' > /etc/locale.conf
echo 'KEYMAP=ru' > /etc/vconsole.conf
echo 'FONT=cyr-sun16' >> /etc/vconsole.conf
chmod 644 /etc/locale.conf
chmod 644 /etc/vconsole.conf
setfont cyr-sun16
locale-gen >/dev/null 2>&1; RETVAL=$?
systemctl restart dhcpcd
dhcpcd >/dev/null
clear
echo '










                             {=-=-=-=-=-=-=--=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=}






                                   ▄████████    ▄█    █▄       ▄████████    ▄████████       ▄██████▄     ▄████████
                                  ███    ███   ███    ███     ███    ███   ███    ███      ███    ███   ███    ███
                                  ███    █▀    ███    ███     ███    █▀    ███    █▀       ███    ███   ███    █▀
                                  ███         ▄███▄▄▄▄███▄▄  ▄███▄▄▄      ▄███▄▄▄          ███    ███   ███
                                ▀███████████ ▀▀███▀▀▀▀███▀  ▀▀███▀▀▀     ▀▀███▀▀▀          ███    ███ ▀███████████
                                         ███   ███    ███     ███    █▄    ███             ███    ███          ███
                                   ▄█    ███   ███    ███     ███    ███   ███             ███    ███    ▄█    ███
                                 ▄████████▀    ███    █▀      ██████████   ███              ▀██████▀   ▄████████▀




                                                                  {  Manjaro based  }

                              {=-=--=-=-=-=-=--=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=}

'
sleep 6
clear
echo '













                                           ▄▀             Добро пожаловать в программу установки
                                       █▀▀▀█▀█
                                        ▀▄░▄▀
                                          █                             Shef OS  !
                                        ▄▄█▄▄
                                        <────────────────────────────────────────────────────────────────────>



                                              Внимание !  скрипт НЕ создает разделы на диске , разделы вы


                                          создаёте сами , поэтому если вы еще не создали разделы - создайте их



                                    <───────────────────────────────────────────────────────────────────────────>
'
    echo -e "
      \t                                                 -> Пропустить введите     1    "

    echo -e "

      \t                                                 -> Разметить диск введите   2     "

    echo -n "

                                                         -> Введите значение : "

      read main_menu
      case "$main_menu" in
         "1" ) clear
           ;;
         "2" ) clear ; echo '

















                                                       Добро пожаловать в меню раметки диска !

                                          . ────────────────────────────────────────────────────────────.
                                          .                                                             .
                                          .                                                             .
                                          .         Сейчас будет выведена информация о дисках           .
                                          .                                                             .
                                          .          Выберите тот диск который надо разметить           .
                                          .                                                             .
                                          .                                                             .
                                          .    ** Имя диска например ( sda , sdb, sdc , nvme0n1 ) **    .
                                          .                                                             .
                                          .                                                             .
                                          . ────────────────────────────────────────────────────────────.
'
sleep 2
read -t 99999 -n 1 -s -r -p "
                                                       -> Нажмите Enter для продолжения <- "
clear
fdisk -l

sleep 2
read -t 99999 -n 1 -s -r -p "
                                                      -> Нажмите Enter для продолжения <- "
clear
echo '















                                                              Выбор диска для разметки

                                           .─────────────────────────────────────────────────────────────.
                                           .                                                             .
                                           .                                                             .
                                           .              Введите имя диска для разметки                 .
                                           .                                                             .
                                           .                                                             .
                                            ──────────────────────────────────────────────────────────────
'
read -p "
                                                  -> Введите значение : " namedisk
cfdisk /dev/$namedisk
      esac
clear

echo '








                                                               Настройка часового пояса

                                           .──────────────────────────────────────────────────────────────.
                                           .                                                              .
                                           .                                                              .
                                           .  Настройка региона выставляет часовой пояс и время согласно  .
                                           .                                                              .
                                           .                      указаному региону                       .
                                           .                                                              .
                                           .  Название региона можно посмотреть в списке регионов или     .
                                           .                                                              .
                                           .  ввести вручную , если уже знаете , именно в таком формате   .
                                           .                                                              .
                                           .                  Пример -->   /Europe/Moscow                 .
                                           .                                                              .
                                           .                                                              .
                                           .──────────────────────────────────────────────────────────────.

'
read -p "
                                                    -> Введите значение : " region

clear
echo '











                                                                    Выбор диска для GRUB

                                              . ────────────────────────────────────────────────────────────.
                                              .                                                             .
                                              .                                                             .
                                              .  ** Это важно для дальнейщей установки загрузчика GRUB  **  .
                                              .                                                             .
                                              .                                                             .
                                              .         Сейчас будет выведена информация о дисках           .
                                              .                                                             .
                                              .   Выберите тот диск на который будет установлена система    .
                                              .                                                             .
                                              .            Например ( sda , sdb, sdc , nvme0n1p )           .
                                              .                                                             .
                                              .                                                             .
                                              . ────────────────────────────────────────────────────────────.
'
sleep 2
read -t 99999 -n 1 -s -r -p "
                                                          -> Нажмите Enter для продолжения <- "
clear
fdisk -l

sleep 2
read -t 99999 -n 1 -s -r -p "
                                                          -> Нажмите Enter для продолжения <- "

clear
echo '












                                                                    Выбор диска для GRUB

                                               .─────────────────────────────────────────────────────────────.
                                               .                                                             .
                                               .                                                             .
                                               .             Введите имя диска для разметки                  .
                                               .                                                             .
                                               .   ** Это важно для дальнейщей установки загрузчика GRUB **  .
                                               .                                                             .
                                               .         Например ( sda , sdb, sdc , nvme0n1p )              .
                                               .                                                             .
                                               .                                                             .
                                               ──────────────────────────────────────────────────────────────.
'
read -p "
                                                       -> Введите значение : " disk
clear
echo '










                                                                         Выбор разделов

                                      .────────────────────────────────────────────────────────────────────────────────.
                                      .                                                                                .
                                      .                                                                                .
                                      .                             Введите разделы диска                              .
                                      .                                                                                .
                                      .             (Root- Корневой)  (Boot- Загрузочный) (Swap- Подкачка)             .
                                      .                                                                                .
                                      .                                                                                .
                                      .                  Например ( sda2, sdb2, sdc2 , nvme0n1p2 )                     .
                                      .                                                                                .
                                      .                                                                                .
                                      .   ** Внимание ! Если вы не создали swap или home то оставьте поле пустым **    .
                                      .                                                                                .
                                      .                                                                                .
                                      .────────────────────────────────────────────────────────────────────────────────.

'
read -p "
                                                                  -> Boot: " boot
read -p "
                                                                  -> Root: " root
read -p "
                                                                  -> Swap: " swap
read -p "
                                                                  -> Home: " home

clear
echo '












                                                             Выбор файловой системы Boot раздела

                                                 .─────────────────────────────────────────────────────────────.
                                                 .                                                             .
                                                 .                                                             .
                                                 .      Выберите файловую систему загрузочного  boot раздела   .
                                                 .                                                             .
                                                 .  Согласно вашей версии Bios (обычный стрый BIOS или UEFI)   .
                                                 .                                                             .
                                                 .   Для UEFI формат FAT32 . Для обычнго BIOS Ext4 или Ext2    .
                                                 .                                                             .
                                                 .                                                             .
                                                 .─────────────────────────────────────────────────────────────.
'
echo -e "\t

                                                      -> Для UEFI введите     1    "
echo -e "\t

                                                      -> Не форматировать  введите      2

                                                      ( Для утсановки в один раздел DOS/MBR или рядом с Windows )"
echo -e "\t

                                                      -> Для обычного Bios форматировать в Ext4 введите    3   "
echo -e "\t

                                                      -> Для обычного Bios фоматировать в Ext2 введиет    4   "
echo -n "

                                                          -> Введите значение : "
read main_menu
      case "$main_menu" in
         "1" ) clear ; mkfs.vfat -F32 /dev/$boot
         ;;
         "3" ) clear ; mkfs.ext4 /dev/$boot
         ;;
         "4" ) clear ; mkfs.ext2 /dev/$boot
         ;;
         "2" ) clear
      esac


clear

mkfs.btrfs -f /dev/$root

mkswap /dev/$swap

swapon /dev/$swap

clear

echo '









                                                                   Монтирование разделов

                                                                и  домашнего ( home ) раздела

                                                   .───────────────────────────────────────────────────────.
                                                   .                                                       .
                                                   .                                                       .
                                                   .       Выберите один из вариантов монтирования         .
                                                   .                                                       .
                                                   .                                                       .
                                                   .───────────────────────────────────────────────────────.
'
echo -e "\t


                                                    ->  Монтировать в BTRFS без Home введите     1     "

echo -e "\t

                                                    -> Форматировать Home в btrfs и смонтрировать  введите    2    "

echo -n "

                                                       -> Введите значение : "

read main_menu
      case "$main_menu" in
        "1") clear ;
mount  /dev/$root /mnt

btrfs su cr /mnt/@

btrfs su cr /mnt/@home

btrfs su cr /mnt/@var

btrfs su cr /mnt/@var_log

btrfs su cr /mnt/@snapshots

umount /mnt

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@ /dev/$root /mnt

mkdir /mnt/{boot,home,var,var_log,.snapshots}

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@home  /dev/$root  /mnt/home

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@var  /dev/$root  /mnt/var

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@var_log /dev/$root /mnt/var_log

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@snapshots  /dev/$root  /mnt/.snapshots
        ;;
        "2" ) clear ;
mkfs.btrfs -f /dev/$home

mount  /dev/$root /mnt

btrfs su cr /mnt/@

btrfs su cr /mnt/@home

btrfs su cr /mnt/@var

btrfs su cr /mnt/@var_log

btrfs su cr /mnt/@snapshots

umount /mnt

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@ /dev/$root /mnt

mkdir /mnt/{boot,home,var,var_log,.snapshots}

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@home  /dev/$home  /mnt/home

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@var  /dev/$root  /mnt/var

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@var_log /dev/$root /mnt/var_log

mount -o rw,noatime,compress=zstd:2,space_cache=v2,discard=async,subvol=@snapshots  /dev/$root  /mnt/.snapshots
   esac

clear
echo '












                                                                   Монтирование boot раздела

                                                  .──────────────────────────────────────────────────────────.
                                                  .                                                          .
                                                  .                                                          .
                                                  .          Монтирование загрузочного раздела !             .
                                                  .                                                          .
                                                  .   Выберите один из варинтов монтирования boot раздела    .
                                                  .                                                          .
                                                  .       Для обычного биоса (НЕ UEFI) введите Bios          .
                                                  .                                                          .
                                                  .             Для UEFI биоса , введите Uefi                .
                                                  .                                                          .
                                                  .                                                          .
                                                  .──────────────────────────────────────────────────────────.
'
echo -e "\t
                                                         -> Для UEFI или EFI введите    1    "
echo -e "\t

                                                         -> Для обычного Bios введите    2   "

echo -e "\t
                                                         -> Без boot раздела DOS/MBR     3

                                                         (Если вы устанавливаете все в один радел для  MBR ) "

echo -n "
                                                           -> Введите значение : "
read main_menu
      case "$main_menu" in
         "1" ) mkdir /mnt/boot/efi ; mount /dev/$boot /mnt/boot/efi
         ;;
         "2" ) mount /dev/$boot  /mnt/boot/
         ;;
         "3" ) clear
      esac

clear
echo '













                                                                         Парль root

                                              .───────────────────────────────────────────────────────────.
                                              .                                                           .
                                              .                                                           .
                                              .                   Укажите парль Root !!!                  .
                                              .                                                           .
                                              .                                                           .
                                              .───────────────────────────────────────────────────────────.
'
read -p "
                                                  -> Введите пароль root :  " password
clear
echo '













                                                                Учетная запись пользователя

                                              .───────────────────────────────────────────────────────────.
                                              .                                                           .
                                              .                                                           .
                                              .           Введите имя вашей учетной записи !!!            .
                                              .                                                           .
                                              .                                                           .
                                              .    Имя учетной записи вводится только маленькими буквами  .
                                              .                                                           .
                                              .───────────────────────────────────────────────────────────.
'
read -p "
                                                   -> Введите имя учетной записи :  " username
clear
echo '













                                                             Парль учетной записи пользователя

                                               .───────────────────────────────────────────────────────────.
                                               .                                                           .
                                               .                                                           .
                                               .           Укажите парль вашей учетной записи !!!          .
                                               .                                                           .
                                               .                                                           .
                                               .───────────────────────────────────────────────────────────.
'
read -p "
                                                   -> Введите пароль пользователя :  " userpassword
clear

echo '










                ____________________¶¶¶¶¶¶¶
                ___________________¶¶
                __________________¶¶
                _________________¶¶
                ________________¶¶
                _______________¶¶             Добро пожаловать в меню установки графических драйверов
                ____$$$$$$$$$$$$$$$$$$
                _____$_______________$       ──────────────────────────────────────────────────────────>
                ______$________ZZZZ$
                _______$_____ZZZZZ$          Здесь вы можете выбрать драйвера для INTEL , AMD , NVIDIA
                ________$__ZZZZZZ$
                _________$ZZZZZZ$
                __________$ZZZZ$             А также установить проприетарный или свободный (nouveau) драйвер NVIDIA
                ___________$ZZ$
                ____________$$               ──────────────────────────────────────────────────────────────────────────>
                ___________ $$$
                __________$$$$$$
                ________$$$$$$$$$$           Или драйвера для гибридной графики INTEL + NVIDIA , AMD + NVIDIA и т.д
                _____$$$$$$$$$$$$$$

                ───────────────────────────────────────────────────────────────────────────────────────────────────────────>
'
echo -e "\t
                                                       -> Для графики Intel введите ( 1 ) "
echo -e "\t


                                                       -> Для графики AMD введите   ( 2 )  "

echo -e "\t

                                                       -> Для графики NVIDIA введите ( 3 ) "

echo -e "\t

                                                       -> Ручная установка драйвера Nvidia ( 4 ) "

echo -e "\t

                                                       -> Для установки драйвера гибридной графики
                                                        Например INTEL + NVIDIA , AMD + NVIDIA и т.д  ( 5 ) "
echo -n "

                                                          -> Введите значение : "
read main_menu
      case "$main_menu" in
         "1" ) graphc_drivers='basestrap -i /mnt xf86-video-intel mesa mesa-demos lib32-mesa vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet libva-intel-driver lib32-libva-intel-driver tbb whois acpica enblend-enfuse ibus-libpinyin igsc intel-compute-runtime intel-gmmlib intel-gpu-tools intel-graphics-compiler intel-media-driver intel-media-sdk intel-metee intel-metee-doc intel-mkl intel-mkl-static intel-opencl-clang libchewing libmfx libva-utils onednn openimagedenoise openipmi openvkl presage python-intelhex rkcommon sdcc tipp10 zh-autoconvert qt6-shadertools spirv-tools vulkan-extra-layers vulkan-extra-tools vulkan-headers vulkan-html-docs vulkan-mesa-layers vulkan-swrast vulkan-validation-layers python-glfw vkd3d lib32-vkd3d lib32-vulkan-mesa-layers lib32-vulkan-validation-layers spirv-tools freeglut ftgl gl2ps glslang gtkglext opengl-man-pages python-opengl blur-effect gambas3-gb-opengl gambas3-gb-opengl-glsl gambas3-gb-opengl-glu gambas3-gb-opengl-sge gambas3-gb-qt5-opengl glava glbinding glm guichan libvdpau-va-gl mupdf-gl ocaml-lablgl opencsg python-glfw soil virtualgl lib32-freeglut lib32-glu lib32-libepoxy --noconfirm'
        ;;
         "2" ) graphc_drivers='basestrap -i /mnt xf86-video-ati xf86-video-amdgpu mesa mesa-demos lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet --noconfirm'
        ;;
         "3" )
clear
echo '












                                                    Добро пожаловать в меню установки драйвера NVIDIA

                                                 .───────────────────────────────────────────────────────.
                                                 .                                                       .
                                                 .       Здесь два варинта установки драйверов           .
                                                 .                                                       .
                                                 .   Open source драйвер  и проприетарный драйвер        .
                                                 .                                                       .
                                                 .   Опенсоурс драйвер лучше для видеокарт старых ,      .
                                                 .                                                       .
                                                 .  до архитектуры Kepler , а для новых видеокарт лучше  .
                                                 .                                                       .
                                                 .    проприетарный драйвер . Выберите свой варинт       .
                                                 .                                                       .
                                   <───────────────────────────────────────────────────────────────────────────────────>

                                       Установка драйвера не гарантирует что все с первого раза запуститься хорошо.

                                              Nvidia не открывает свой код для написания нормальных драйверов ,

                                        поэтому гарантировать что драйвер заведется после установки невозможно !!!

                                    <────────────────────────────────────────────────────────────────────────────────>
'
echo -e "\t


                                                      ->  Установить проприетарный драйвер     1     "
echo -e "\t


                                                       ->  Установить Open source драйвер      2    "
echo -n "

                                                          -> Введите значение : "
read main_menu
      case "$main_menu" in
       "1" )
       graphc_drivers='basestrap -i /mnt mesa mesa-demos lib32-mesa vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet --noconfirm'
       nvidia_driver="mhwd -a pci nonfree 0300"
       ;;
       "2" ) graphc_drivers='basestrap -i /mnt mesa mesa-demos lib32-mesa vulkan-icd-loader lib32-vulkan-icd-loader xf86-video-nouveau nvidia-utils lib32-nvidia-utils vulkan-icd-loader lib32-vulkan-icd-loader lib32-opencl-nvidia opencl-nvidia network-manager-applet --noconfirm'
     esac
        ;;
        "4" )
clear
echo '












                                                Добро пожаловать в меню ручной установки драйверов NVIDIA

                                           <─────────────────────────────────────────────────────────────────>

                                           Здесь вам будет показан список доступных для установки драйверов Nvidia

                                              Далее вам надо будет ввести назание этого драйвера для установки

                                               Например драйвер  video-nvidia , и прописать в поле для ввода

                                    <───────────────────────────────────────────────────────────────────────────────────>

                                         Установка драйвера не гарантирует что все с первого раза запуститься хорошо.

                                              Nvidia не открывает свой код для написания нормальных драйверов ,

                                          поэтому гарантировать что драйвер заведется после установки невозможно !!!

                                      <────────────────────────────────────────────────────────────────────────────────>
'
echo -e "\t

                                                             ->   Продолжить    1     "

echo -n "

                                                             -> Введите значение : "
read main_menu
      case "$main_menu" in
         "1" )
         clear ; mhwd --list
         read -p "
                                                           -> Введите значение : " namedriver

         hwddriver='mhwd --install pci $namedriver'
      esac

        ;;
        "5" )
clear
echo '












                                            Добро пожаловать в меню установки драйверов для гибридной графики

                                  .─────────────────────────────────────────────────────────────────────────────────────.
                                  .                                                                                     .
                                  . Установка драйвера Nvidia не гарантирует ,что все с первого раза запуститься хорошо .
                                  .                                                                                     .
                                  .      Nvidia не открывает свой код для написания нормальных драйверов ,              .
                                  .                                                                                     .
                                  .    поэтому гарантировать что драйвер заведется после установки невозможно !!!       .
                                  .                                                                                     .
                                   ──────────────────────────────────────────────────────────────────────────────────────
'
echo -e "\t

                                                       ->  INTEL + AMD      1     "

echo -e "\t
                                                       ->  INTEL + NVIDIA ( Проприетарный драйвер  Nvidia )     2    "
echo -e "\t

                                                       ->  INTEL + NVIDIA ( Open source драйвер Nvidia )     3    "

echo -e "\t
                                                       ->  AMD + NVIDA   ( Проприетарный драйвер  Nvidia )    4    "

echo -e "\t
                                                       ->  AMD + NVIDA   ( Open source драйвер Nvidia )    5    "
echo -n "


                                                        -> Введите значение : "
read main_menu
      case "$main_menu" in
       "1" )
       graphc_drivers='basestrap -i /mnt xf86-video-intel mesa mesa-demos lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet libva-intel-driver lib32-libva-intel-driver libva-intel-driver lib32-libva-intel-driver tbb whois acpica enblend-enfuse ibus-libpinyin igsc intel-compute-runtime intel-gmmlib intel-gpu-tools intel-graphics-compiler intel-media-driver intel-media-sdk intel-metee intel-metee-doc intel-mkl intel-mkl-static intel-opencl-clang libchewing libmfx libva-utils onednn openimagedenoise openipmi openvkl presage python-intelhex rkcommon sdcc tipp10 zh-autoconvert lib32-libva-intel-driver lib32-vulkan-intel libva-intel-driver qt6-shadertools spirv-tools vulkan-extra-layers vulkan-extra-tools vulkan-headers vulkan-html-docs vulkan-mesa-layers vulkan-swrast vulkan-validation-layers python-glfw vkd3d lib32-vkd3d lib32-vulkan-mesa-layers lib32-vulkan-validation-layers spirv-tools freeglut ftgl gl2ps glslang gtkglext opengl-man-pages python-opengl blur-effect gambas3-gb-opengl gambas3-gb-opengl-glsl gambas3-gb-opengl-glu gambas3-gb-opengl-sge gambas3-gb-qt5-opengl glava glbinding glm guichan libvdpau-va-gl mupdf-gl ocaml-lablgl opencsg python-glfw soil virtualgl lib32-freeglut lib32-glu lib32-libepoxy lib32-mesa mesa-demos vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader libva-intel-driver lib32-libva-intel-driver network-manager-applet optimus-manager optimus-manager-plasma --noconfirm'
       optimus="systemctl enable optimus-manager"
       ;;
       "2" )
       graphc_drivers='basestrap -i /mnt xf86-video-intel mesa mesa-demos lib32-mesa vulkan-icd-loader lib32-vulkan-icd-loader vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet libva-intel-driver lib32-libva-intel-driver libva-intel-driver lib32-libva-intel-driver tbb whois acpica enblend-enfuse ibus-libpinyin igsc intel-compute-runtime intel-gmmlib intel-gpu-tools intel-graphics-compiler intel-media-driver intel-media-sdk intel-metee intel-metee-doc intel-mkl intel-mkl-static intel-opencl-clang libchewing libmfx libva-utils onednn openimagedenoise openipmi openvkl presage python-intelhex rkcommon sdcc tipp10 zh-autoconvert lib32-libva-intel-driver lib32-vulkan-intel libva-intel-driver qt6-shadertools spirv-tools vulkan-extra-layers vulkan-extra-tools vulkan-headers vulkan-html-docs vulkan-mesa-layers vulkan-swrast vulkan-validation-layers python-glfw vkd3d lib32-vkd3d lib32-vulkan-mesa-layers lib32-vulkan-validation-layers spirv-tools freeglut ftgl gl2ps glslang gtkglext opengl-man-pages python-opengl blur-effect gambas3-gb-opengl gambas3-gb-opengl-glsl gambas3-gb-opengl-glu gambas3-gb-opengl-sge gambas3-gb-qt5-opengl glava glbinding glm guichan libvdpau-va-gl mupdf-gl ocaml-lablgl opencsg python-glfw soil virtualgl lib32-freeglut lib32-glu lib32-libepoxy lib32-mesa mesa-demos vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader libva-intel-driver lib32-libva-intel-driver network-manager-applet optimus-manager optimus-manager-plasma --noconfirm'
       nvidia_driver="mhwd -a pci nonfree 0300"
       optimus="systemctl enable optimus-manager"
       ;;
       "3" )
       graphc_drivers='basestrap -i /mnt xf86-video-intel mesa mesa-demos lib32-mesa vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader xf86-video-nouveau nvidia-utils lib32-nvidia-utils vulkan-icd-loader lib32-vulkan-icd-loader lib32-opencl-nvidia opencl-nvidia vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet libva-intel-driver lib32-libva-intel-driver libva-intel-driver lib32-libva-intel-driver tbb whois acpica enblend-enfuse ibus-libpinyin igsc intel-compute-runtime intel-gmmlib intel-gpu-tools intel-graphics-compiler intel-media-driver intel-media-sdk intel-metee intel-metee-doc intel-mkl intel-mkl-static intel-opencl-clang libchewing libmfx libva-utils onednn openimagedenoise openipmi openvkl presage python-intelhex rkcommon sdcc tipp10 zh-autoconvert lib32-libva-intel-driver lib32-vulkan-intel libva-intel-driver qt6-shadertools spirv-tools vulkan-extra-layers vulkan-extra-tools vulkan-headers vulkan-html-docs vulkan-mesa-layers vulkan-swrast vulkan-validation-layers python-glfw vkd3d lib32-vkd3d lib32-vulkan-mesa-layers lib32-vulkan-validation-layers spirv-tools freeglut ftgl gl2ps glslang gtkglext opengl-man-pages python-opengl blur-effect gambas3-gb-opengl gambas3-gb-opengl-glsl gambas3-gb-opengl-glu gambas3-gb-opengl-sge gambas3-gb-qt5-opengl glava glbinding glm guichan libvdpau-va-gl mupdf-gl ocaml-lablgl opencsg python-glfw soil virtualgl lib32-freeglut lib32-glu lib32-libepoxy lib32-mesa mesa-demos vulkan-intel lib32-vulkan-intel vulkan-icd-loader lib32-vulkan-icd-loader libva-intel-driver lib32-libva-intel-driver network-manager-applet optimus-manager optimus-manager-plasma --noconfirm'
       ;;
       "4" )
       graphc_drivers='basestrap -i /mnt xf86-video-ati xf86-video-amdgpu mesa mesa-demos lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader network-manager-applet optimus-manager optimus-manager-plasma --noconfirm'
       nvidia_driver="mhwd -a pci nonfree 0300"
       optimus="systemctl enable optimus-manager"
       ;;
       "5" )
       graphc_drivers='basestrap -i /mnt xf86-video-ati xf86-video-amdgpu mesa mesa-demos lib32-mesa vulkan-radeon lib32-vulkan-radeon vulkan-icd-loader lib32-vulkan-icd-loader vulkan-icd-loader lib32-vulkan-icd-loader xf86-video-nouveau nvidia-utils lib32-nvidia-utils vulkan-icd-loader lib32-vulkan-icd-loader lib32-opencl-nvidia opencl-nvidia network-manager-applet optimus-manager optimus-manager-plasma --noconfirm'
       optimus="systemctl enable optimus-manager"
      esac

      esac
clear

echo '







                                                              Дополнительные настройки

                                                .───────────────────────────────────────────────────────.
                                                .                                                       .
                                                .         Сюда входит установка программ :              .
                                                .                                                       .
                                                .                                                       .
                                                .  gwe -> программа для управления частоами и вольтажом .
                                                .                                                       .
                                                .    видеокарт Nvidia (для разгона)                     .
                                                .                                                       .
                                                .                                                       .
                                                .  intel-power-control -> программа для управления      .
                                                .                                                       .
                                                .   частотами графики Intel (для разгона)               .
                                                .                                                       .
                                                .                                                       .
                                                .    А также можно включить специальный параметр        .
                                                .                                                       .
                                                .                       ibt=off                         .
                                                .                                                       .
                                                .     На случай если у вас kernel panik или запуск      .
                                                .                                                       .
                                                .   в черный экран на видеокартах Nvidia особенно для   .
                                                .                                                       .
                                                .          Nvidia 3060 lite  , Nvidia 3060 ti           .
                                                .                                                       .
                                                .                                                       .
                                                . И еще включения режима максимальной производительности.
                                                .                                                       .
                                                .                      Cpupower                         .
                                                .                                                       .
                                                .───────────────────────────────────────────────────────.
                                                         * Чтобы пропустить нажмите Enter *
'
echo -e "\t
                                                      ->  Установить Gwe   ( 1 )  "

echo -e "\t
                                                      ->  Установить intel-power-control  ( 2 )  "
echo -e "\t

                                                      ->  Включить  ibt=off   ( 3 )  "
echo -e "\t

                                                      ->  Включить Cpupower   ( 4 )  "
echo -e "\t

                                                      ->  Посмотреть дополнительные варианты ( 5 ) "

echo -n "

                                                                -> Введите значение : "
read main_menu
      case "$main_menu" in
      "1" ) GWE=gwe
       ;;
      "2" ) IPC=intel-power-control-git
       ;;
      "3" )
       ;;
      "4" )
       ;;
      "5" )
clear
echo '













                                               .───────────────────────────────────────────────────────────.
                                               .                                                           .
                                               .                                                           .
                                               .                  Дополнительные варианты                  .
                                               .                                                           .
                                               .                                                           .
                                               .───────────────────────────────────────────────────────────.
'
echo -e "\t
                                                        ->  Gwe  +  ibt=off   ( 6 )  "

echo -e "\t
                                                        ->  Gwe  +  ibt=off  +  Cpupower  ( 7 ) "

echo -e "\t
                                                        ->  ibt=off  +  Cpupower  ( 8 )"

echo -e "\t
                                                        ->  intel-power-control +  Cpupower  ( 9 )"

echo -n "

                                                        -> Введите значение : "
read main_menu
      case "$main_menu" in
      "6" )
       ;;
      "7" )
       ;;
      "8" )
       ;;
      "9" )
      esac

      esac

clear
#----------------------------------------------------------------------|
#                                                      #
#                         Pacman                       #
#                                                      #
#----------------------------------------------------------------------|
sed -i "/\[multilib\]/,/Include/"'s/^#//' /etc/pacman.conf
sed -i s/'#ParallelDownloads = 5'/'ParallelDownloads = 5'/g /etc/pacman.conf
sed -i s/'#VerbosePkgLists'/'VerbosePkgLists'/g /etc/pacman.conf
sed -i s/'#Color'/'ILoveCandy'/g /etc/pacman.conf
sed -i s/'CheckSpace'/'#CheckSpace'/g /etc/pacman.conf
sed -i s/'#VerbosePkgLists'/'VerbosePkgLists'/g /etc/pacman.conf
echo '









───────────────────────────────────────────────────────────────|
──────────────────────
────────────────────── ██████╗  █████╗  ██████╗███╗   ███╗ █████╗ ███╗   ██╗
────────────────────── ██╔══██╗██╔══██╗██╔════╝████╗ ████║██╔══██╗████╗  ██║
──▒▒▒▒▒────▄████▄───── ██████╔╝███████║██║     ██╔████╔██║███████║██╔██╗ ██║
─▒─▄▒─▄▒──███▄█▀────── ██╔═══╝ ██╔══██║██║     ██║╚██╔╝██║██╔══██║██║╚██╗██║
─▒▒▒▒▒▒▒─▐████──█──█── ██║     ██║  ██║╚██████╗██║ ╚═╝ ██║██║  ██║██║ ╚████║
─▒▒▒▒▒▒▒──█████▄────── ╚═╝     ╚═╝  ╚═╝ ╚═════╝╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝
─▒─▒─▒─▒───▀████▀─────────────────────────────────────────────────────────────────|

                       Пожалуйста пдождите , идет настройка скачивания пакетов,

                                  это займет пару мнгновений ) .......

              ─────────────────────────────────────────────────────────────────────────────────────|
'
sleep 4

pacman-mirrors --fasttrack
pacman -Syy
pacman -Sy arch-install-scripts --noconfirm
basestrap -i /mnt base base-devel linux61 linux61-headers linux-firmware dosfstools btrfs-progs intel-ucode amd-ucode iucode-tool archlinux-keyring manjaro-keyring cups bluez bluez-utils manjaro-tools-base networkmanager dhcpcd dhclient vim nano pipewire pipewire-alsa pipewire-jack pipewire-media-session manjaro-pipewire zsh zsh-completions mhwd mhwd-db python-gobject --noconfirm
fstabgen -U /mnt >> /mnt/etc/fstab
arch-chroot /mnt /bin/bash -c "ln -sf /usr/share/zoneinfo/$region /etc/localtime"
arch-chroot /mnt /bin/bash -c "hwclock --systohc"
arch-chroot /mnt /bin/bash -c "sed -i s/'#en_US.UTF-8'/'en_US.UTF-8'/g /etc/locale.gen"
arch-chroot /mnt /bin/bash -c "sed -i s/'#ru_RU.UTF-8'/'ru_RU.UTF-8'/g /etc/locale.gen"
arch-chroot /mnt /bin/bash -c "locale-gen"
arch-chroot /mnt /bin/bash -c "echo 'LANG=ru_RU.UTF-8' > /etc/locale.conf"
arch-chroot /mnt /bin/bash -c "echo 'KEYMAP=ru' > /etc/vconsole.conf"
arch-chroot /mnt /bin/bash -c "echo 'FONT=cyr-sun16' >> /etc/vconsole.conf"
arch-chroot /mnt /bin/bash -c "echo 'Manjaro' > /etc/hostname"
arch-chroot /mnt /bin/bash -c "echo '127.0.0.1 localhost' > /etc/hosts"
arch-chroot /mnt /bin/bash -c "echo '::1       localhost' >> /etc/hosts"
arch-chroot /mnt /bin/bash -c "echo '127.0.0.1 Manjaro.localdomain Manjaro' >> /etc/hosts"
#----------------------------PACMAN--------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "sed -i s/'#ParallelDownloads = 5'/'ParallelDownloads = 5'/g /etc/pacman.conf"
arch-chroot /mnt /bin/bash -c "sed -i s/'#VerbosePkgLists'/'VerbosePkgLists'/g /etc/pacman.conf"
arch-chroot /mnt /bin/bash -c "sed -i s/'#Color'/'ILoveCandy'/g /etc/pacman.conf"
arch-chroot /mnt /bin/bash -c "sed -i s/'CheckSpace'/'#CheckSpace'/g /etc/pacman.conf"
arch-chroot /mnt /bin/bash -c "sed -i s/'#VerbosePkgLists'/'VerbosePkgLists'/g /etc/pacman.conf"
#-------------------------------------------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "sed -i s/'# %wheel ALL=(ALL:ALL) ALL'/'%wheel ALL=(ALL:ALL) ALL'/g /etc/sudoers"
#----------------------------SUDOERS------------------------------------------------------------------
echo "root:$password" | arch-chroot /mnt chpasswd
arch-chroot /mnt /bin/bash -c "mkinitcpio -P"
arch-chroot /mnt /bin/bash -c "pacman -Syy grub grub-btrfs efibootmgr --noconfirm"
arch-chroot /mnt /bin/bash -c "useradd -m -G wheel -s /bin/bash $username"
echo "$username:$userpassword" | arch-chroot /mnt chpasswd
arch-chroot /mnt /bin/bash -c "systemctl enable NetworkManager"
arch-chroot /mnt /bin/bash -c "grub-install /dev/$disk"
arch-chroot /mnt /bin/bash -c "grub-mkconfig -o /boot/grub/grub.cfg"
#----------------------------GRUB----------------------------------------------------------------------
sed -i s/'GRUB_CMDLINE_LINUX_DEFAULT="quiet udev.log_priority=3"'/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off"'/g /mnt/etc/default/grub
arch-chroot /mnt /bin/bash -c "sed -i s/'GRUB_DEFAULT=saved'/'GRUB_DEFAULT=0'/g /etc/default/grub"
arch-chroot /mnt /bin/bash -c "sed -i s/'GRUB_TIMEOUT=5'/'GRUB_TIMEOUT=0'/g /etc/default/grub"
arch-chroot /mnt /bin/bash -c "sed -i s/'GRUB_SAVEDEFAULT=true'/'GRUB_SAVEDEFAULT=false'/g /etc/default/grub"
arch-chroot /mnt /bin/bash -c "sed -i s/'MODULES=()'/'MODULES=(crc32c libcrc32c zlib_deflate btrfs)'/g /etc/mkinitcpio.conf"
arch-chroot /mnt /bin/bash -c "sed -i s/'HOOKS=(base udev autodetect modconf kms keyboard keymap consolefont block filesystems fsck)'/'HOOKS=(base udev autodetect modconf kms keyboard keymap block filesystems fsck)'/g /etc/mkinitcpio.conf"
#-----------------------------MAKEPKG---------------------------------------------------
sed -i s/'CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"'/'CXXFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt"'/g /mnt/etc/makepkg.conf
sed -i s/'#RUSTFLAGS="-C opt-level=2"'/'RUSTFLAGS="-C opt-level=2 -C target-cpu=native"'/g /mnt/etc/makepkg.conf
sed -i s/'MAKEFLAGS="-j2"'/'MAKEFLAGS="-j$(($(nproc)+1))"'/g /mnt/etc/makepkg.conf
fileName="/mnt/etc/makepkg.conf"
flags="\"-march=native -mtune=native -O2 -pipe -fno-plt\""

CFLAGSline=`grep -hnr "\"" $fileName | grep CFLAGS | cut -d ":" -f1 |head -n1`
for (( i=$CFLAGSline+1;i<`wc -l $fileName|cut -d " " -f1`;i++ )) {
  output=`sed -n "$i p" $fileName`
  if [[ `echo $output | grep "\""` ]];then
   break
  fi
}
sed -i "s/CFLAGS=.*/CFLAGS=$flags/" $fileName
sed -i "$(($CFLAGSline+1)),$i d" $fileName
#--------------------------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "mkinitcpio -P"
arch-chroot /mnt /bin/bash -c "grub-mkconfig -o /boot/grub/grub.cfg"
pacman -Sc --noconfirm
pacman -Syy
arch-chroot /mnt /bin/bash -c "pacman-mirrors --fasttrack"
arch-chroot /mnt /bin/bash -c "pacman -Syyuu --noconfirm"
#-------------------------------------------------------------------------------------------
arch-chroot /mnt /bin/bash -c "${nvidia_driver}"
arch-chroot /mnt /bin/bash -c "${hwddriver}"
${graphc_drivers}
#-------------------------------------------------------------------------------------------
pacman -Sc --noconfirm
pacman -Syy
basestrap -i /mnt xorg xorg-xrandr xorg-server xdg-utils xorg-xinit xdg-user-dirs plasma sddm sddm-kcm konsole kmix dolphin nemo discover manjaro-settings-manager manjaro-settings-manager-kcm manjaro-icons manjaro-printer print-manager kmix pavucontrol pipewire pipewire-jack pipewire-alsa pipewire-media-session flameshot kcalc ark screenfetch neofetch htop bpytop gnome-usage firefox gwenview dragon kwrite mousepad easyeffects conky gparted timeshift timeshift-autosnap-manjaro manjaro-input baobab libpamac libpamac-flatpak-plugin libpamac-snap-plugin pamac-cli pamac-gtk webapp-manager-manjaro noto-fonts-emoji ttf-font-awesome ttf-dejavu ttf-ubuntu-font-family libappimage appimagelauncher xapp-appimage-thumbnailer ffmpegthumbnailer ffmpegthumbs yay openvpn networkmanager-openvpn git wget cups manjaro-pipewire os-prober go zsh zsh-completions qemu-desktop gnome-boxes libvirt virt-manager telegram-desktop spectacle udisks2 gvfs-mtp gvfs-gphoto2 gvfs-afc gvfs-smb sshfs cups tumbler poppler-glib ffmpegthumbnailer freetype2 libgsf totem gnome-epub-thumbnailer file-roller file-roller unzip ntfs-3g imagemagick ffmpegthumbs flac wavpack lame a52dec libdca libmad libmpcdec opencore-amr opus speex libvorbis faac faad2 libfdk-aac  fdkaac  jasper libwebp libavif libheif aom dav1d rav1e svt-av1 libde265 libdv libmpeg2 schroedinger libtheora libvpx  x264 x265 xvidcore mkvtoolnix-cli ogmtools gstreamer xine-lib gst-libav ffmpeg qt6-multimedia-ffmpeg ktorrent qbittorrent p7zip dnsmasq os-prober apparmor zstd cabextract tar openssl lib32-openssl gamemode lib32-gamemode desktop-file-utils curl dbus haveged dbus-broker cpupower zenity lsb-release nss lsof lib32-freetype2 lib32-libgl lib32-gcc-libs lib32-libx11 lib32-libxss lib32-alsa-plugins lib32-libgpg-error lib32-nss mhwd mhwd-db gnome-disk-utility lrzip unrar unzip unace squashfs-tools ttf-liberation audacious audacious-plugins playerctl android-file-transfer android-tools android-udev alsa-utils alsa-plugins  alsa-oss alsa-firmware sof-firmware alsa-ucm-conf  alsa-tools sof-tools simplescreenrecorder lib32-simplescreenrecorder asciiquarium kdiskmark partitionmanager inxi steam steam-native-runtime gputils lshw --noconfirm
#-------------------------------------
      case "$main_menu" in
       "3" )
       sed -i s/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off"'/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off ibt=off"'/g /mnt/etc/default/grub
        ;;
       "4" )
       touch /mnt/etc/systemd/system/cpupower.service
       echo '[Unit]' > /mnt/etc/systemd/system/cpupower.service
       echo 'Description=Set CPU governor to performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Service]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'Type=oneshot' >> /mnt/etc/systemd/system/cpupower.service
       echo 'ExecStart=/usr/bin/cpupower -c all frequency-set -g performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Install]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'WantedBy=multi-user.target' >> /mnt/etc/systemd/system/cpupower.service
       ;;
       "6" )
       GWE=gwe
       sed -i s/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off"'/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off ibt=off"'/g /mnt/etc/default/grub
       ;;
       "7" )
       GWE=gwe
       sed -i s/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off"'/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off ibt=off"'/g /mnt/etc/default/grub
       touch /mnt/etc/systemd/system/cpupower.service
       echo '[Unit]' > /mnt/etc/systemd/system/cpupower.service
       echo 'Description=Set CPU governor to performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Service]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'Type=oneshot' >> /mnt/etc/systemd/system/cpupower.service
       echo 'ExecStart=/usr/bin/cpupower -c all frequency-set -g performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Install]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'WantedBy=multi-user.target' >> /mnt/etc/systemd/system/cpupower.service
       ;;
       "8" )
       sed -i s/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off"'/'GRUB_CMDLINE_LINUX_DEFAULT="quiet splash udev.log_priority=0 rootfstype=btrfs selinux=0 raid=noautodetect noibrs noibpb no_stf_barrier tsx=on tsx_async_abort=off elevator=noop mitigations=off ibt=off"'/g /mnt/etc/default/grub
       touch /mnt/etc/systemd/system/cpupower.service
       echo '[Unit]' > /mnt/etc/systemd/system/cpupower.service
       echo 'Description=Set CPU governor to performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Service]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'Type=oneshot' >> /mnt/etc/systemd/system/cpupower.service
       echo 'ExecStart=/usr/bin/cpupower -c all frequency-set -g performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Install]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'WantedBy=multi-user.target' >> /mnt/etc/systemd/system/cpupower.service
       ;;
       "9" )
       IPC=intel-power-control-git
       touch /mnt/etc/systemd/system/cpupower.service
       echo '[Unit]' > /mnt/etc/systemd/system/cpupower.service
       echo 'Description=Set CPU governor to performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Service]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'Type=oneshot' >> /mnt/etc/systemd/system/cpupower.service
       echo 'ExecStart=/usr/bin/cpupower -c all frequency-set -g performance' >> /mnt/etc/systemd/system/cpupower.service
       echo '[Install]' >> /mnt/etc/systemd/system/cpupower.service
       echo 'WantedBy=multi-user.target' >> /mnt/etc/systemd/system/cpupower.service
      esac
#------------------------------------
clear
echo '















                                        ▄▀
                                    █▀▀▀█▀█
                                     ▀▄░▄▀
                                       █                Установка дополнительных пакетов с AUR
                                     ▄▄█▄▄
                                      <────────────────────────────────────────────────────────────────────>

                                              Stacer  -> программа очистки системы

                                              Ananicy  -> распределяющий приоритет задач (повышвет отклик системы)

                                              Zramswap  -> Сервис интеллектуального размещения zram в озу

                                              Hardinfo  -> диспетчер устройств

                                              StartWine -> Программа для запуска приложений и игор Windows под линуксом

                                              Grub Customizer  -> программа для настройки загрузчика GRUB

'
sleep 7
#------------------------MAKEPKG>CONF------------------------------
sed -i s/'CXXFLAGS="$CFLAGS -Wp,-D_GLIBCXX_ASSERTIONS"'/'CXXFLAGS="-march=native -mtune=native -O2 -pipe -fno-plt"'/g /etc/makepkg.conf
sed -i s/'#RUSTFLAGS="-C opt-level=2"'/'RUSTFLAGS="-C opt-level=2 -C target-cpu=native"'/g /etc/makepkg.conf
sed -i s/'MAKEFLAGS="-j2"'/'MAKEFLAGS="-j$(($(nproc)+1))"'/g /etc/makepkg.conf
fileName="/etc/makepkg.conf"
flags="\"-march=native -mtune=native -O2 -pipe -fno-plt\""

CFLAGSline=`grep -hnr "\"" $fileName | grep CFLAGS | cut -d ":" -f1 |head -n1`
for (( i=$CFLAGSline+1;i<`wc -l $fileName|cut -d " " -f1`;i++ )) {
  output=`sed -n "$i p" $fileName`
  if [[ `echo $output | grep "\""` ]];then
   break
  fi
}
sed -i "s/CFLAGS=.*/CFLAGS=$flags/" $fileName
sed -i "$(($CFLAGSline+1)),$i d" $fileName
#----------------------------------------------------------------------
pacman -Sc --noconfirm
pacman -Syy
pacman -S base-devel --noconfirm
#---------------------------------
mkdir -p /home/manjaro/tools
mkdir -p /mnt/home/$username/tools
chown manjaro /mnt/home/$username/tools
cd /home/manjaro/tools
#-----------------------StartWine---------------------------------------------------|
packages=(startwine)
for package in "${packages[@]}"; do
  git clone https://gitlab.com/hybrid-project-developers/pkgbuilds/hybrid-extra-pkgbuilds/$package.git
  chown manjaro /home/manjaro/tools/$package
  cd $package
  su manjaro -c "export PKGDEST=/mnt/home/$username/tools ; makepkg -src --noconfirm"
  cd ..
done
packages=(ananicy-git grub-customizer-gtk zramswap stacer-bin hardinfo $GWE $IPC)
for package in "${packages[@]}"; do
  git clone https://aur.archlinux.org/$package.git
  chown manjaro /home/manjaro/tools/$package
  cd $package
  su manjaro -c "export PKGDEST=/mnt/home/$username/tools ; makepkg -src --noconfirm"
  cd ..
done
#-----------------------------------------------------------------------------------|
pacman -Sc --noconfirm
pacman -Syy
rm -Rf /home/manjaro/tools/startwine
rm -Rf /home/manjaro/tools/ananicy-git
rm -Rf /home/manjaro/tools/grub-customizer-gtk
rm -Rf /home/manjaro/tools/zramswap
rm -Rf /home/manjaro/tools/stacer-bin
rm -Rf /home/manjaro/tools/hardinfo
rm -Rf /home/manjaro/tools/$GWE
rm -Rf /home/manjaro/tools/$IPC
#-----------------------------------------------------------------------------------|
packages=(onlyoffice-bin)
for package in "${packages[@]}"; do
  git clone https://aur.archlinux.org/$package.git
  chown manjaro /home/manjaro/tools/$package
  cd $package
  su manjaro -c "export PKGDEST=/mnt/home/$username/tools ; makepkg -src --noconfirm"
  cd ..
done
arch-chroot /mnt /bin/bash -c "pacman -U home/$username/tools/*.tar.zst --noconfirm"
#arch-chroot /mnt /bin/bash -c "rm -Rf home/$username/tools"
#--------------------------------------------------------------------------------------|
${optimus}
arch-chroot /mnt /bin/bash -c "mkinitcpio -P"
arch-chroot /mnt /bin/bash -c "grub-mkconfig -o /boot/grub/grub.cfg"
arch-chroot /mnt /bin/bash -c "systemctl enable bluetooth"
arch-chroot /mnt /bin/bash -c "systemctl enable cups"
arch-chroot /mnt /bin/bash -c "systemctl enable libvirtd"
arch-chroot /mnt /bin/bash -c "systemctl enable ananicy"
arch-chroot /mnt /bin/bash -c "systemctl enable zramswap"
arch-chroot /mnt /bin/bash -c "systemctl enable cpupower"
arch-chroot /mnt /bin/bash -c "systemctl enable haveged"
arch-chroot /mnt /bin/bash -c "systemctl enable --now dbus-broker.service"
arch-chroot /mnt /bin/bash -c "systemctl enable NetworkManager"
arch-chroot /mnt /bin/bash -c "systemctl enable sddm --force"

